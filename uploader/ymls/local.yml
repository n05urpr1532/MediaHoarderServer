---
- hosts: localhost
  gather_facts: false
  tasks:
    - name: include rClone aliases
      include_tasks: '/opt/mhs/lib/uploader/bin/bin.yml'

    - name: include rClone cron jobs
      include_tasks: '/opt/mhs/lib/uploader/ymls/cron.yml'

    - name: Register hdpath
      shell: 'cat /var/mhs/state/server.hd.path'
      register: hdpath

    - name: Create Basic Directories
      file: 'path={{item}} state=directory mode=0775 owner=1000 group=1000 recurse=true'
      with_items:
        - '/var/mhs/log'
        - '/var/mhs/log/drive'
        - '/var/mhs/log/emergency'
        - '/var/mhs/log/uploader'
        - '/opt/mhs/lib/roles/log'
      ignore_errors: yes

    - debug: msg="Combined Path - {{multihds}}"

    - name: Install Union Script
      template:
        src: /opt/mhs/lib/uploader/mounts/local.sh
        dest: /opt/mhs/etc/mhs/pgunion.sh
        force: yes

    - name: Install Union Service
      template:
        src: /opt/mhs/lib/uploader/mounts/pgunion.service
        dest: /etc/systemd/system/pgunion.service
        force: yes

    - name: Reload Union Service
      systemd:
        daemon_reload: yes
        enabled: yes
        state: reloaded
        name: pgunion

    - name: Sleep 2 Seconds
      wait_for: timeout=2
